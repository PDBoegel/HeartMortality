---
title: 
author: 
date: 
output: html_document
---
Gathering Data:
```{r}
heartmortCOMPLETE = read.csv(file = "https://raw.githubusercontent.com/PDBoegel/HeartMortality/master/HeartMort.csv", header = TRUE)
heartmort = heartmortCOMPLETE[-c(1:4,7,24:26)] #Getting rid of variables for metadata and other dependent variable

```

# Basic data manipulation to better fit normality assumptions for linear models

```{r}
heartmort$PCTPOPUNDER65 = heartmortCOMPLETE$PCTPOP30TO65 + heartmortCOMPLETE$PCTPOPUNDER30 # To account for elderly population
heartmort <- subset(heartmort, AVGINCOMEPERPERSON > 0)
summary(heartmort)
```
```{r, results='hide'}
par(mfrow = c(2,3))
lapply(1:ncol(heartmort), function(i) hist(heartmort[,i], xlab = names(heartmort)[i], main = paste("Histogram of", names(heartmort)[i])))
```

From looking at the summary and histograms of the Variables, those that need to be transformed are:

Log transform:
POPSIZE [log]
HDMORTPERPERSON [log]
POPDENSITY [log]
HOUSINGUNITS [log]
HOUSINGUNITDENSITY [log]
AVGINCOMEPERPERSON [log]
TOTUNEMPLOYED [log]

categorized:
All Percentage variables besides diabetes and obesity

Notes: Some data in AVGINCOMEPERPERSON is zero which is strange might want to consider removing these points, otherwise we add one so their log values are inf    
```{r, results='hide'}
heartmort$LNPOPSIZE <- log(heartmort$POPSIZE)
heartmort$LNHDMORTPERPERSON <- log(heartmort$HDMORTPERPERSON)
heartmort$LNPOPDENSITY <- log(heartmort$POPDENSITY)
heartmort$LNHOUSINGUNITS <- log(heartmort$HOUSINGUNITS)
heartmort$LNHOUSINGUNITDENSITY <- log(heartmort$HOUSINGUNITDENSITY)
heartmort$LNAVGINCOMEPERPERSON <- log(heartmort$AVGINCOMEPERPERSON + 1)
heartmort$LNTOTUNEMPLOYED <- log(heartmort$TOTUNEMPLOYED)

heartmort$TOTDIABETES <- (log(heartmort$POPSIZE * (heartmort$PCTDIABETES/100)))
heartmort$TOTMALE <- (log(heartmort$POPSIZE * (heartmort$PCTMALE/100)))
heartmort$TOTFEMALE <- (log(heartmort$POPSIZE * (heartmort$PCTFEMALE/100)))
heartmort$TOTWHITE <- (log(heartmort$POPSIZE * (heartmort$PCTWHITE/100)))
heartmort$TOTASIANAM <- (log(heartmort$POPSIZE * (heartmort$PCTASIANAM/100)))
heartmort$TOTNATIVEAM <- (log(heartmort$POPSIZE * (heartmort$PCTNATIVEAM/100)))
heartmort$TOTLOWEDU <- (log(heartmort$POPSIZE * (heartmort$LOWEDUCATION/100)))
heartmort$TOTMEDEDU <- (log(heartmort$POPSIZE * (heartmort$MEDEDUCATION/100)))
heartmort$TOTHIGHEDU <- (log(heartmort$POPSIZE * (heartmort$HIGHEDUCATION/100)))
heartmort$TOTNONELDERLY <- (log(heartmort$POPSIZE * (heartmort$PCTPOPUNDER65/100)))
par(mfrow = c(2,3))
lapply(21:ncol(heartmort), function(i) hist(heartmort[,i], xlab = names(heartmort)[i], main = paste("Histogram of", names(heartmort)[i])))
```

# Basic linear models

```{r}
naivelm = lm(LNHDMORTPERPERSON ~ LNPOPSIZE + LNHOUSINGUNITS + LNAVGINCOMEPERPERSON , data = heartmort)
summary(naivelm)
```

```{r, eval = FALSE}
tlm = lm(HDMORTPERPERSON ~ 1, data = heartmort)
summary(tlm)
```

```{r, eval = FALSE}
newmodel <- lm(HDMORTPERPERSON ~ HOUSINGUNITS + PCTDIABETES + PCTWHITE + PCTAFRAM + PCTASIANAM + PCTNATIVEAM + PCTOBESE + PCTPOPUNDER65, data = heartmort)
summary(newmodel)
```


```{r, eval = FALSE}
#newmodel <- lm(HDMORTPERPERSON ~ HOUSINGUNITS + PCTDIABETES + PCTWHITE + PCTAFRAM + PCTASIANAM + PCTNATIVEAM + PCTOBESE + PCTPOPUNDER65 + factor(MALEDOM), data = heartmort)
#summary(newmodel)
```

```{r, eval = FALSE}
resid = rstandard(tlm)
leverage = hatvalues(tlm) 

hist(resid, main="Histogram of Standardized Residuals", xlab = "Standardized Residual")


k = dim(heartmort)[2]
n = dim(heartmort)[1]
averagelev = (k+1)/n
3*averagelev
hist(leverage, main="Histogram of Leverages", xlab = "Leverage", breaks = 15)
```


```{r, eval = FALSE}
which(leverage > 3*averagelev)
length(which(leverage > 3*averagelev))

which(leverage > 6*averagelev)
length(which(leverage > 6*averagelev))

```

```{r, eval = FALSE}
levs <-as.numeric(which(leverage > 3*averagelev))
levs
lev6heartmort = heartmort[-levs,]
lmlev6 = lm(HDMORTPERPERSON ~ ., data = lev6heartmort)
summary(lmlev6)
```

```{r, eval = FALSE}
residlev6 = rstandard(lmlev6)
leveragelev6 = hatvalues(lmlev6) 

hist(residlev6, main="Histogram of Standardized Residuals", xlab = "Standardized Residual")


k = dim(lev6heartmort)[2]
n = dim(lev6heartmort)[1]
averagelev = (k+1)/n
3*averagelev
hist(leveragelev6, main="Histogram of Leverages", xlab = "Leverage", breaks = 15)


```

### Notes ###########################

Get rid of percents - multiply demographic percents by population in each county

Eliminate high leverage points before transforming variables

**Eliminating high lev points from nontransformed data**
```{r, eval = FALSE}
residnontrans = rstandard(naivelm)
leveragenontrans = hatvalues(naivelm) 

hist(resid, main="Histogram of Standardized Residuals", xlab = "Standardized Residual")


k = dim(heartmort)[2]
n = dim(heartmort)[1]
averagelev = (k+1)/n
3*averagelev
hist(leveragenontrans, main="Histogram of Leverages", xlab = "Leverage", breaks = 15)
```


```{r, eval=FALSE}
which(leveragenontrans > 3*averagelev)
length(which(leveragenontrans > 3*averagelev))

which(leveragenontrans > 6*averagelev)
length(which(leveragenontrans > 6*averagelev))

```

```{r, eval=FALSE}
levs2 <-as.numeric(which(leveragenontrans > 3*averagelev))
levs2
lev6heartmortnontrans = heartmort[-levs2,]
lmlev6nontrans = lm(HDMORTPERPERSON ~ ., data = lev6heartmortnontrans)
summary(lmlev6nontrans)
```

```{r, eval = FALSE}
residlev6nontrans = rstandard(lmlev6nontrans)
leveragelev6nontrans = hatvalues(lmlev6nontrans) 

hist(residlev6nontrans, main="Histogram of Standardized Residuals", xlab = "Standardized Residual")


k = dim(lev6heartmortnontrans)[2]
n = dim(lev6heartmortnontrans)[1]
averagelev = (k+1)/n
3*averagelev
hist(leveragelev6nontrans, main="Histogram of Leverages", xlab = "Leverage", breaks = 15)
max(leveragelev6nontrans)


```

